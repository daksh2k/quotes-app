package com.example.quotesapp.data.local

import androidx.arch.core.executor.testing.InstantTaskExecutorRule
import androidx.room.Room
import androidx.test.core.app.ApplicationProvider.getApplicationContext
import androidx.test.ext.junit.runners.AndroidJUnit4
import androidx.test.filters.SmallTest
import com.example.quotesapp.data.model.QuoteApiModel
import com.google.common.truth.Truth.assertThat
import com.google.gson.Gson
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.test.runTest
import org.junit.After
import org.junit.Before
import org.junit.Rule
import org.junit.Test
import org.junit.runner.RunWith


@ExperimentalCoroutinesApi
@RunWith(AndroidJUnit4::class)
@SmallTest
class QuoteDaoTest {

    // Executes each task synchronously using Architecture Components.
    @get:Rule
    var instantExecutorRule = InstantTaskExecutorRule()

    private val simulatedRequest = Gson().fromJson(
        "{\"ignoredAuthors\":null,\"ignoredTags\":null,\"isRandom\":true,\"quotes\":[{\"author\":\"Ashlecka Aumrivani\",\"quote\":\"Because we idealize Giving so much, we ignore the ability, blessing, and duty to Receive.\",\"quoteId\":\"60ff412849661fa3a9119997\",\"source\":\"\",\"tags\":\"giving, psychology, receiving\"},{\"author\":\"Lynn Viehl\",\"quote\":\"There will never be another woman for me, Alexandra. You are my eternity. -Michael\",\"quoteId\":\"60ff416649661fa3a9137989\",\"source\":\"Stay the Night\",\"tags\":\"paranormal\"},{\"author\":\"Heather Brewer\",\"quote\":\"We were the new people here. We weren\\u2019t part of their group. We had to prove ourselves.\",\"quoteId\":\"60ff416949661fa3a9139607\",\"source\":\"The Cemetery Boys\",\"tags\":\"heather-brewer, ya\"},{\"author\":\"Gina Greenlee\",\"quote\":\"Let your body move. It will give voice to a language that can heal.\",\"quoteId\":\"60ff414949661fa3a912a1d1\",\"source\":\"Postcards and Pearls: Life Lessons from Solo Moments on the Road\",\"tags\":\"body, body-mind-spirit, body-movement, healing, health\"},{\"author\":\"General William T. Sherman\",\"quote\":\"There is many a boy here today who looks on war as all glory  but boys  it is all hell.\",\"quoteId\":\"60ff41ab49661fa3a91597e0\",\"source\":\"\",\"tags\":\"realistic, expectations\"},{\"author\":\"Bryant McGill\",\"quote\":\"One positive thought will shift the entire world under your feet.\",\"quoteId\":\"60ff414149661fa3a91266c1\",\"source\":\"Simple Reminders: Inspiration for Living Your Best Life\",\"tags\":\"growth, positivity, teaching, thoughts\"},{\"author\":\"Colin Powell\",\"quote\":\"Success is the result of perfection, hard work, learning from failure, loyalty, and persistence.\",\"quoteId\":\"60ff411b49661fa3a9112573\",\"source\":\"\",\"tags\":\"inspirational-quotes, motivational-quotes\"},{\"author\":\"Eleanor B. Stock\",\"quote\":\"Goodwill... is an immeasurable and tremendous energy  the atomic energy of the spirit.\",\"quoteId\":\"60ff41a849661fa3a9157545\",\"source\":\"\",\"tags\":\"helping, people\"},{\"author\":\"Stephen Richards\",\"quote\":\"If you want the Cinderella moments then you have to believe in magick.\",\"quoteId\":\"60ff41ae49661fa3a915b3e7\",\"source\":\"\",\"tags\":\"affirmational, cinderella-moments, empowering-quotes-for-women, life-changing-moments, self-help-quotes, stephen-richards-author\"},{\"author\":\"Joe Mari Fadrigalan\",\"quote\":\"One's greatest happiness is also his greatest weakness.\",\"quoteId\":\"60ff419749661fa3a914f39a\",\"source\":\"\",\"tags\":\"happiness, life, weakness\"},{\"author\":\"Jeanette Winterson\",\"quote\":\"I am good at walking away. Rejection teaches you how to reject.\",\"quoteId\":\"60ff416349661fa3a9135d3d\",\"source\":\"Weight: The Myth of Atlas and Heracles\",\"tags\":\"hurt, rejection\"},{\"author\":\"Lailah Gifty Akita\",\"quote\":\"If you meditate on the Holy Scriptures, you mind shall me on the Jesus Christ, the Saviour,\",\"quoteId\":\"60ff40f649661fa3a90ff1c2\",\"source\":\"\",\"tags\":\"christianity, encouragement, healthy-living, meditate, meditation, mind, mind-power, religion, spirituality, theology\"},{\"author\":\"Lailah Gifty Akita\",\"quote\":\"Christ change my life.\",\"quoteId\":\"60ff410a49661fa3a9109f85\",\"source\":\"\",\"tags\":\"change, christian-life, grace, life, save-souls, spiritual\"},{\"author\":\"AVA.\",\"quote\":\"you giver of light.you lover of love.you beautifulbeautifulhuman beingyou.\",\"quoteId\":\"60ff40f149661fa3a90fc83a\",\"source\":\"you are safe here.\",\"tags\":\"beautiful, human, human-being, human-nature, inspirational, love, poems, poetry, prose, qotd, quotes, wisdom\"},{\"author\":\"Raheem Kirlew\",\"quote\":\"Love is like fire.Leave it alone and you will be okay,play with it and you get burnt\",\"quoteId\":\"60ff415349661fa3a912ebcb\",\"source\":\"\",\"tags\":\"love, romance, sad\"},{\"author\":\"Almost everyone in my life.\",\"quote\":\"It is what it is.\",\"quoteId\":\"60ff412149661fa3a9115f9a\",\"source\":\"\",\"tags\":\"life, reality\"},{\"author\":\"Old saying\",\"quote\":\"Today's sales should be better than yesterday's - and worse than tomorrow's.\",\"quoteId\":\"60ff41a449661fa3a91552ac\",\"source\":\"\",\"tags\":\"capitalism\"},{\"author\":\"Sunday Adelaja\",\"quote\":\"Create the best of yourself, become your best self.\",\"quoteId\":\"60ff40fb49661fa3a9102150\",\"source\":\"How To Become Great Through Time Conversion: Are you wasting time, spending time or investing time?\",\"tags\":\"calling, conversion, convert, gift, great, greatness, humanity, life, live-your-best-life, poverty, produce, product, productivity, purpose, time, value, waste, wealth, work, world\"},{\"author\":\"Sirio Berati\",\"quote\":\"Made up of some holy freaking atoms.\",\"quoteId\":\"60ff40fe49661fa3a9103612\",\"source\":\"\",\"tags\":\"inspirational, science\"},{\"author\":\"Tom Althouse\",\"quote\":\"Get on top of the obstacles and they become vantage points.\",\"quoteId\":\"60ff417049661fa3a913c27e\",\"source\":\"\",\"tags\":\"healthy-attitude, inspirational, options, perseverance, positive-thinking-quotes, success-in-business, success-strategies, successful-living\"},{\"author\":\"Al Capone\",\"quote\":\"You can go a long way with a smile. You can go a lot farther with a smile and a gun.\",\"quoteId\":\"60ff416f49661fa3a913bd1d\",\"source\":\"\",\"tags\":\"smile\"},{\"author\":\"Colson Whitehead\",\"quote\":\"Here's a tip for new parents: Start lowering those expectations early, it's going to pay off later.\",\"quoteId\":\"60ff412549661fa3a9117f7b\",\"source\":\"The Noble Hustle: Poker, Beef Jerky, and Death\",\"tags\":\"children, expectations, parenting, parents\"},{\"author\":\"Drew  Hayes\",\"quote\":\"Vampire strength might not let me lift cars, but I will tear up some shrubbery all day long.\",\"quoteId\":\"60ff413e49661fa3a9124bc6\",\"source\":\"The Utterly Uninteresting and Unadventurous Tales of Fred, the Vampire Accountant\",\"tags\":\"accountant, high-school-reunion, lions, magic, shifters, vampire, walking-dead, wolves, zonbie\"},{\"author\":\"Friedrich Nietzsche\",\"quote\":\"He who has a why to live for can bear almost any how.\",\"quoteId\":\"60ff41a749661fa3a9156c88\",\"source\":\"\",\"tags\":\"goals\"},{\"author\":\"Gabriel Garc\\u00eda M\\u00e1rquez\",\"quote\":\"The memory of the past did not redeem the future, as he insisted on believing.\",\"quoteId\":\"60ff418b49661fa3a9149b59\",\"source\":\"\",\"tags\":\"nostalgia\"},{\"author\":\"Curtis Tyrone Jones\",\"quote\":\"Sometimes we must gravitate towards madness before we can levitate on greatness.\",\"quoteId\":\"60ff40fb49661fa3a9101add\",\"source\":\"\",\"tags\":\"focus, gravity, greatness, inspirational, levitation, life, life-lessons, madness, perseverance, poetry, wisdom\"},{\"author\":\"Sabrina Salas\",\"quote\":\"That one person you are is you...its hurts but try love maybe it will get you through\",\"quoteId\":\"60ff413b49661fa3a912387b\",\"source\":\"\",\"tags\":\"inspirational-life\"},{\"author\":\"Sukant Ratnakar\",\"quote\":\"I woke up in morning and saw, world has moved on\",\"quoteId\":\"60ff418249661fa3a91458d3\",\"source\":\"Open The Windows: To the World around You\",\"tags\":\"change, innovation, success\"},{\"author\":\"Maya Banks\",\"quote\":\"I guess what they say is true. Anything the government wants to hide, they stick it in New Mexico\",\"quoteId\":\"60ff418149661fa3a9144da1\",\"source\":\"Whispers in the Dark\",\"tags\":\"romantic-suspense\"},{\"author\":\"Eraldo Banovac\",\"quote\":\"The best advice will come from the person who has no personal interest in the matter.\",\"quoteId\":\"60ff40eb49661fa3a90f9745\",\"source\":\"\",\"tags\":\"advice, advice-for-daily-living, advice-quotes, inspirational-quotes, motivational-quotes, personal-interest, philosophy, philosophy-of-life, philosophy-quotes, sociology, sociology-quotes\"},{\"author\":\"Steve Maraboli\",\"quote\":\"I am in love with the serendipitous poetry with which this universe expresses itself.\",\"quoteId\":\"60ff415b49661fa3a9132806\",\"source\":\"\",\"tags\":\"love, poetry, universe\"},{\"author\":\"John Bercow\",\"quote\":\"I think the record shows that as Speaker, I have taken the lead in cleaning up politics.\",\"quoteId\":\"60ff41c849661fa3a916990d\",\"source\":\"\",\"tags\":\"Cleaning, Think, Lead \"},{\"author\":\"Winston Churchill\",\"quote\":\"Never in the field of human conflict was so much owed by so many to so few.\",\"quoteId\":\"60ff41a549661fa3a9155e61\",\"source\":\"\",\"tags\":\"england\"},{\"author\":\"Sinclair Lewis\",\"quote\":\"People will buy anything that is 'one to a customer.'\",\"quoteId\":\"60ff41af49661fa3a915bee9\",\"source\":\"\",\"tags\":\"People, Customer, Anything \"},{\"author\":\"Toba Beta\",\"quote\":\"Do you understand what I'm saying?Pardon? I just wanna hear you talking.\",\"quoteId\":\"60ff416749661fa3a913823e\",\"source\":\"Master of Stupidity\",\"tags\":\"communication\"},{\"author\":\"Donny Deutsch\",\"quote\":\"You know you're doing what you love when Sunday nights feel the same as Friday nights....\",\"quoteId\":\"60ff40fa49661fa3a9101180\",\"source\":\"'s Big Idea: How To Make Your Entrepreneurial Dreams Come True, From The AHA Moment To Your First Million\",\"tags\":\"entrepreneur, motivational\"},{\"author\":\"Jandy Nelson\",\"quote\":\"Mom has a massive sunflower for a soul so big there's hardly any room in her for organs.\",\"quoteId\":\"60ff410d49661fa3a910b022\",\"source\":\"I'll Give You the Sun\",\"tags\":\"flower, mom, mother, soul, sunflower\"},{\"author\":\"Lailah Gifty Akita\",\"quote\":\"There is a deep light within my soul.\",\"quoteId\":\"60ff413349661fa3a911f476\",\"source\":\"Think Great: Be Great!\",\"tags\":\"christian-living, christianity, faith-strength, light, light-and-darkness, shine-on, soul-quotes, spiritual-quotes, spiritual-wisdom\"},{\"author\":\"Shelley K. Wall\",\"quote\":\"I want my life to be about LIVING, not leaving --which is why I'm LEAVING nothing behind.\",\"quoteId\":\"60ff412a49661fa3a911a8cd\",\"source\":\"Numbers Never Lie\",\"tags\":\"humor, living, living-life-to-the-fullest\"},{\"author\":\"Parnell Hall\",\"quote\":\"It is my personal belief that writing cannot be taught.\",\"quoteId\":\"60ff414b49661fa3a912b210\",\"source\":\"\",\"tags\":\"writers, writers-on-writing\"},{\"author\":\"Jim George\",\"quote\":\"There are always consequences to wrong choices.\",\"quoteId\":\"60ff40e849661fa3a90f82e3\",\"source\":\"\",\"tags\":\"choices, christians, consequences, decisions, god, jim-george, wrongs\"},{\"author\":\"William Blake\",\"quote\":\"Opposition is true friendship.\",\"quoteId\":\"60ff41c849661fa3a9169aa0\",\"source\":\"\",\"tags\":\"True Friendship, True \"},{\"author\":\"Richard Ford\",\"quote\":\"I'm intrigued by how ordinary behavior exists so close beside its opposite.\",\"quoteId\":\"60ff416e49661fa3a913b5ab\",\"source\":\"Canada\",\"tags\":\"canada, crime, literary\"},{\"author\":\"Louisa May Alcott\",\"quote\":\"\\u2026wisely mingled poetry and prose.\",\"quoteId\":\"60ff40f249661fa3a90fd129\",\"source\":\"Little Women\",\"tags\":\"little-women, louisa-may-alcott, poetry, prose\"},{\"author\":\"John Paul II\",\"quote\":\"Social justice cannot be attained by violence. Violence kills what it intends to create.\",\"quoteId\":\"60ff416f49661fa3a913bc77\",\"source\":\"\",\"tags\":\"john-paul-ii, violence\"},{\"author\":\"Ain Eineziz\",\"quote\":\"The only person that you should try to be better than is the person you were yesterday\",\"quoteId\":\"60ff414449661fa3a9127c1a\",\"source\":\"\",\"tags\":\"self\"},{\"author\":\"Bryant McGill\",\"quote\":\"No belief or idea is sacred, unless it treats all people as sacred\",\"quoteId\":\"60ff417849661fa3a914001d\",\"source\":\"Voice of Reason\",\"tags\":\"beliefs, blessed, ideas\"},{\"author\":\"Martin Luther King\",\"quote\":\"I want to be the white man's brother  not his brother-in-law.\",\"quoteId\":\"60ff41a949661fa3a91583f7\",\"source\":\"Jr.\",\"tags\":\"minorities\"},{\"author\":\"Joem S. Aguilar\",\"quote\":\"Miracles don't just happen on their own you know, you got to make them happen.\",\"quoteId\":\"60ff419149661fa3a914bfc2\",\"source\":\"\",\"tags\":\"inspirational, miracles, motivational\"},{\"author\":\"Unknown\",\"quote\":\"Bless them: Change me! Will get the author of this saying and get back to you.\",\"quoteId\":\"60ff40ff49661fa3a910426f\",\"source\":\"\",\"tags\":\"spirituality\"}],\"quotesPresent\":183610,\"quotesReturned\":50,\"requestedAuthors\":null,\"requestedTags\":null}\n",
        QuoteApiModel::class.java
    )


    private lateinit var database: AppDatabase

    @Before
    fun initDb() {
        database = Room.inMemoryDatabaseBuilder(
            getApplicationContext(),
            AppDatabase::class.java
        ).allowMainThreadQueries().build()
    }

    @Test
    fun insertQuotesAndGetThem() = runTest {
        database.quoteDao().insertAll(simulatedRequest.quotes)
        val loaded = database.quoteDao().getQuotes()
        assertThat(loaded).isNotNull()
        assertThat(loaded.size).isEqualTo(simulatedRequest.quotes.size)
        assertThat(loaded[0].author).isEqualTo(simulatedRequest.quotes[0].author)
        assertThat(loaded[0].quoteId).isEqualTo(simulatedRequest.quotes[0].quoteId)
        assertThat(loaded[0].quote).isEqualTo(simulatedRequest.quotes[0].quote)
        assertThat(loaded[0].tags).isEqualTo(simulatedRequest.quotes[0].tags)
    }

    @Test
    fun quotesAreDeleted() = runTest {
        database.quoteDao().insertAll(simulatedRequest.quotes)
        val loaded = database.quoteDao().getQuotes()
        assertThat(loaded).isNotNull()
        assertThat(loaded.size).isEqualTo(simulatedRequest.quotes.size)
        database.quoteDao().deleteAll()
        val afterDelete = database.quoteDao().getQuotes()
        assertThat(afterDelete).isNotNull()
        assertThat(afterDelete.size).isEqualTo(0)
    }


    @After
    fun closeDb() = database.close()


}